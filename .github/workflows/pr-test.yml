name: PR Test

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  issue_comment:
    types: [created]

permissions:
  contents: read          # è¯»å–ä»£ç 
  pull-requests: write   # è¯„è®º PR
  issues: write          # è¯„è®º Issue
  actions: read          # è¯»å– Actions
  checks: write          # å†™å…¥æ£€æŸ¥ç»“æœ

jobs:
  pr-test:
    # è¿è¡Œæ¡ä»¶ï¼š
    # 1. PR äº‹ä»¶
    # 2. è¯„è®ºè§¦å‘ (åŒ…å« "rerun pr test")
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'rerun pr test'))
    
    runs-on: [ self-hosted, macOS ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false
          persist-credentials: true
          fetch-depth: 0
          # å¦‚æœæ˜¯è¯„è®ºè§¦å‘ï¼Œéœ€è¦æ£€å‡º PR çš„ä»£ç 
          ref: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}
      
      - name: Setup configuration
        id: setup-config
        uses: ./.github/actions/setup-config
        with:
          feishu-webhook-url: ${{ secrets.FEISHU_WEBHOOK_URL }}
      
      - name: Setup environment
        uses: ./.github/actions/setup-env
      
      - name: Run unit tests
        run: npm run test:quiet
      
      - name: Check if E2E tests should run
        id: check-e2e
        run: |
          SHOULD_RUN="false"
          
          # æ£€æŸ¥ PR æè¿°æ˜¯å¦åŒ…å« "run e2e test"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_BODY="${{ github.event.pull_request.body }}"
            if echo "$PR_BODY" | grep -q "run e2e test"; then
              SHOULD_RUN="true"
            fi
          fi
          
          # æ£€æŸ¥è¯„è®ºæ˜¯å¦åŒ…å« "run e2e test"
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            if echo "$COMMENT_BODY" | grep -q "run e2e test"; then
              SHOULD_RUN="true"
            fi
          fi
          
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          echo "ğŸ” Should run E2E tests: $SHOULD_RUN"
      
      - name: Run E2E tests
        if: steps.check-e2e.outputs.should_run == 'true'
        id: e2e-tests
        uses: ./.github/actions/run-e2e-tests
        with:
          report-server-url: ${{ steps.setup-config.outputs.REPORT_SERVER_URL }}
      
      - name: Upload E2E test report
        if: always() && steps.check-e2e.outputs.should_run == 'true' && steps.e2e-tests.outputs.report_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-e2e-test-report-${{ github.run_id }}
          path: ${{ steps.e2e-tests.outputs.report_file }}
          retention-days: 30
      
      - name: Check if coverage check should run
        id: check-coverage
        run: |
          SHOULD_RUN="false"
          
          # æ£€æŸ¥ PR æè¿°æ˜¯å¦åŒ…å« "check e2e coverage"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_BODY="${{ github.event.pull_request.body }}"
            if echo "$PR_BODY" | grep -q "check e2e coverage"; then
              SHOULD_RUN="true"
            fi
          fi
          
          # æ£€æŸ¥è¯„è®ºæ˜¯å¦åŒ…å« "check e2e coverage"
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            if echo "$COMMENT_BODY" | grep -q "check e2e coverage"; then
              SHOULD_RUN="true"
            fi
          fi
          
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          echo "ğŸ” Should check E2E coverage: $SHOULD_RUN"
      
      - name: Check E2E coverage
        if: steps.check-coverage.outputs.should_run == 'true'
        id: coverage
        uses: ./.github/actions/check-e2e-coverage
        with:
          report-server-url: ${{ steps.setup-config.outputs.REPORT_SERVER_URL }}
      
      - name: Upload coverage report
        if: always() && steps.check-coverage.outputs.should_run == 'true' && steps.coverage.outputs.report_path != ''
        uses: actions/upload-artifact@v4
        with:
          name: pr-coverage-report-${{ github.run_id }}
          path: ${{ steps.coverage.outputs.report_path }}
          retention-days: 30
      
      - name: Generate PR comment
        if: always() && (steps.check-e2e.outputs.should_run == 'true' || steps.check-coverage.outputs.should_run == 'true')
        id: message
        run: |
          # åˆ¤æ–­æ•´ä½“çŠ¶æ€
          ALL_PASS=true
          
          # E2E æµ‹è¯•çŠ¶æ€ï¼ˆé€šè¿‡ outcome åˆ¤æ–­ï¼Œè€Œä¸æ˜¯ report_existsï¼‰
          if [ "${{ steps.check-e2e.outputs.should_run }}" = "true" ]; then
            if [ "${{ steps.e2e-tests.outcome }}" != "success" ]; then
              ALL_PASS=false
            fi
          fi
          
          # è¦†ç›–ç‡æ£€æŸ¥ä»…ä½œä¸ºä¿¡æ¯å±•ç¤ºï¼Œä¸å½±å“æ•´ä½“çŠ¶æ€
          
          # ç”Ÿæˆéšæœºé¡µè„šæ¶ˆæ¯
          if [ "$ALL_PASS" = "false" ]; then
            TITLE="## âš ï¸ å‘ç°é—®é¢˜"
            FOOTER=$(node .github/scripts/generate-footer.js fail)
          else
            TITLE="## âœ… æµ‹è¯•é€šè¿‡"
            FOOTER=$(node .github/scripts/generate-footer.js pass)
          fi
          
          # æ„å»ºç´§å‡‘å‹æ¶ˆæ¯
          MESSAGE="$TITLE\n\n"
          MESSAGE+="| ç±»å‹ | ç»“æœ |\n"
          MESSAGE+="|:----:|------|\n"
          
          # å•å…ƒæµ‹è¯•è¡Œ
          MESSAGE+="| ğŸ§ª | âœ… å•å…ƒæµ‹è¯• |\n"
          
          # E2E æµ‹è¯•è¡Œ
          if [ "${{ steps.check-e2e.outputs.should_run }}" = "true" ]; then
            # è·å–æŠ¥å‘Š URLï¼ˆæ— è®ºæµ‹è¯•æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰
            REPORT_URL="${{ steps.e2e-tests.outputs.report_url }}"
            
            # æ£€æŸ¥æµ‹è¯•æ˜¯å¦é€šè¿‡ï¼ˆé€šè¿‡æ£€æŸ¥ outcomeï¼‰
            if [ "${{ steps.e2e-tests.outcome }}" = "success" ]; then
              # æµ‹è¯•æˆåŠŸ
              if [ -n "$REPORT_URL" ]; then
                MESSAGE+="| ğŸ”„ | âœ… E2E æµ‹è¯• Â· [æŠ¥å‘Š]($REPORT_URL) |\n"
              else
                MESSAGE+="| ğŸ”„ | âœ… E2E æµ‹è¯• |\n"
              fi
            else
              # æµ‹è¯•å¤±è´¥ï¼Œä½†ä»é™„ä¸ŠæŠ¥å‘Šé“¾æ¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              if [ -n "$REPORT_URL" ]; then
                MESSAGE+="| ğŸ”„ | âŒ E2E æµ‹è¯•å¤±è´¥ Â· [æŸ¥çœ‹æŠ¥å‘Š]($REPORT_URL) |\n"
              else
                MESSAGE+="| ğŸ”„ | âŒ E2E æµ‹è¯•å¤±è´¥ |\n"
              fi
            fi
          else
            MESSAGE+="| ğŸ”„ | â­ï¸ E2E æµ‹è¯• (è·³è¿‡) |\n"
          fi
          
          # è¦†ç›–ç‡è¡Œ
          if [ "${{ steps.check-coverage.outputs.should_run }}" = "true" ]; then
            # è·å–è¦†ç›–ç‡ä¿¡æ¯
            COVERAGE_URL="${{ steps.coverage.outputs.report_url }}"
            COVERAGE_PERCENT="${{ steps.coverage.outputs.coverage_percent }}"
            TESTED_COUNT="${{ steps.coverage.outputs.tested_count }}"
            TOTAL_COUNT="${{ steps.coverage.outputs.total_count }}"
            
            # æ˜¾ç¤ºè¦†ç›–ç‡ç™¾åˆ†æ¯”ï¼ˆå¦‚æœæœ‰æ•°æ®ï¼‰
            if [ -n "$COVERAGE_PERCENT" ] && [ -n "$COVERAGE_URL" ]; then
              MESSAGE+="| ğŸ“ˆ | è¦†ç›–ç‡ ${COVERAGE_PERCENT}% (${TESTED_COUNT}/${TOTAL_COUNT}) Â· [è¯¦æƒ…]($COVERAGE_URL) |\n"
            elif [ -n "$COVERAGE_URL" ]; then
              MESSAGE+="| ğŸ“ˆ | è¦†ç›–ç‡æŠ¥å‘Š Â· [è¯¦æƒ…]($COVERAGE_URL) |\n"
            else
              MESSAGE+="| ğŸ“ˆ | âš ï¸ è¦†ç›–ç‡æ£€æŸ¥å¤±è´¥ |\n"
            fi
          else
            MESSAGE+="| ğŸ“ˆ | â­ï¸ è¦†ç›–ç‡æ£€æŸ¥ (è·³è¿‡) |\n"
          fi
          
          MESSAGE+="\n$FOOTER\n\n"
          MESSAGE+="<sub>Run #${{ github.run_id }}</sub>"
          
          # ä¿å­˜åˆ° GitHub Output
          {
            echo 'content<<EOF'
            echo -e "$MESSAGE"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
      
      - name: Comment on PR
        if: always() && (steps.check-e2e.outputs.should_run == 'true' || steps.check-coverage.outputs.should_run == 'true')
        uses: ./.github/actions/comment-on-pr
        with:
          pat-token: ${{ steps.setup-config.outputs.PAT_TOKEN }}
          message: ${{ steps.message.outputs.content }}
          update-if-exists: 'true'
          comment-identifier: 'PR æµ‹è¯•æŠ¥å‘Š'
