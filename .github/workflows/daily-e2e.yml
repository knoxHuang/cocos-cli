# 每日 E2E 测试与覆盖率检查工作流
#
# 触发方式：
# 1. 手动触发：在 GitHub Actions 页面点击 "Run workflow"
# 2. 定时触发：每天北京时间凌晨 00:00（UTC 16:00）
#
# 功能：
# - 运行完整的 E2E 测试套件
# - 生成可视化的 HTML 测试报告
# - 检查 E2E 测试覆盖率
# - 生成覆盖率报告
# - 发送测试结果和覆盖率到飞书群聊
# - 上传测试报告为 GitHub Artifacts（保留 30 天）

name: Daily E2E Check

on:
  # 手动触发
  workflow_dispatch:
  
  # 定时触发：每天凌晨 12 点（北京时间 = UTC+8，所以 UTC 时间是 16:00）
  schedule:
    - cron: '0 16 * * *'  # 每天 UTC 16:00 = 北京时间 00:00

permissions:
  contents: read          # 读取代码
  actions: read          # 读取 Actions

jobs:
  daily-check:
    runs-on: [ self-hosted, macOS ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false
          persist-credentials: true
          fetch-depth: 0
      
      - name: Setup configuration
        id: setup-config
        uses: ./.github/actions/setup-config
        with:
          feishu-webhook-url: ${{ secrets.FEISHU_WEBHOOK_URL }}
      
      - name: Setup environment
        uses: ./.github/actions/setup-env
      
      - name: Run E2E tests
        id: e2e-tests
        uses: ./.github/actions/run-e2e-tests
        with:
          report-server-url: ${{ steps.setup-config.outputs.REPORT_SERVER_URL }}
      
      - name: Upload test report as artifact
        if: always() && steps.e2e-tests.outputs.report_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daily-e2e-report-${{ github.run_id }}
          path: ${{ steps.e2e-tests.outputs.report_file }}
          retention-days: 30
      
      - name: Check E2E coverage
        id: coverage
        if: always()
        uses: ./.github/actions/check-e2e-coverage
        with:
          report-server-url: ${{ steps.setup-config.outputs.REPORT_SERVER_URL }}
      
      - name: Upload coverage report as artifact (备用)
        if: always() && steps.coverage.outputs.report_path != ''
        uses: actions/upload-artifact@v4
        with:
          name: daily-coverage-report-${{ github.run_id }}
          path: ${{ steps.coverage.outputs.report_path }}
          retention-days: 30
      
      - name: Send to Feishu
        if: always()
        continue-on-error: true
        run: node .github/scripts/send-to-feishu.js
        env:
          FEISHU_WEBHOOK_URL: ${{ steps.setup-config.outputs.FEISHU_WEBHOOK_URL }}
          REPORT_EXISTS: ${{ steps.e2e-tests.outputs.report_exists }}
          REPORT_URL: ${{ steps.e2e-tests.outputs.report_url }}
          REPORT_FILENAME: ${{ steps.e2e-tests.outputs.report_filename }}
          COVERAGE_REPORT_URL: ${{ steps.coverage.outputs.report_url }}
          COVERAGE_REPORT_FILENAME: ${{ steps.coverage.outputs.report_filename }}
          COVERAGE_PERCENT: ${{ steps.coverage.outputs.coverage_percent }}
          TESTED_COUNT: ${{ steps.coverage.outputs.tested_count }}
          TOTAL_COUNT: ${{ steps.coverage.outputs.total_count }}
          COVERAGE_MARKDOWN: ${{ steps.coverage.outputs.markdown }}

