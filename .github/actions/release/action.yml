name: 'Release Build'
description: 'æ„å»ºå‘å¸ƒåŒ…ï¼ˆNode.js æˆ– Electron ç‰ˆæœ¬ï¼‰'

inputs:
  publish-dir:
    description: 'å‘å¸ƒç›®å½•è·¯å¾„'
    required: false
    default: '.publish'
  nodejs:
    description: 'æ˜¯å¦å‘å¸ƒ Node.js ç‰ˆæœ¬'
    required: false
    default: 'true'
  electron:
    description: 'æ˜¯å¦å‘å¸ƒ Electron ç‰ˆæœ¬'
    required: false
    default: 'false'
  create-zip:
    description: 'æ˜¯å¦åˆ›å»º ZIP å‹ç¼©åŒ…'
    required: false
    default: 'true'
  upload:
    description: 'æ˜¯å¦ä¸Šä¼ åˆ° FTP æœåŠ¡å™¨'
    required: false
    default: 'false'
  report-server-url:
    description: 'æŠ¥å‘ŠæœåŠ¡å™¨åœ°å€ï¼ˆç”¨äºç”Ÿæˆä¸‹è½½é“¾æ¥ï¼‰'
    required: false
    default: 'http://192.168.52.77:8080'

outputs:
  release_results:
    description: 'å‘å¸ƒç»“æœ JSONï¼ˆåŒ…å«æ‰€æœ‰ç±»å‹çš„å‘å¸ƒä¿¡æ¯ï¼‰'
    value: ${{ steps.release.outputs.release_results }}
  release_success:
    description: 'å‘å¸ƒæ˜¯å¦æˆåŠŸï¼ˆæ‰€æœ‰ç±»å‹éƒ½æˆåŠŸæ‰ä¸º trueï¼‰'
    value: ${{ steps.release.outputs.release_success }}

runs:
  using: 'composite'
  steps:
    - name: Cleanup old publish files
      id: cleanup
      shell: bash
      run: |
        PUBLISH_DIR="${{ inputs.publish-dir }}"
        # ç¡®ä¿å‘å¸ƒç›®å½•æ˜¯ç»å¯¹è·¯å¾„
        if [[ ! "$PUBLISH_DIR" = /* ]]; then
          PUBLISH_DIR="$GITHUB_WORKSPACE/$PUBLISH_DIR"
        fi
        echo "ğŸ§¹ æ¸…ç†å‘å¸ƒç›®å½•: $PUBLISH_DIR"
        node "$GITHUB_WORKSPACE/.github/scripts/cleanup-publish-dir.js" "$PUBLISH_DIR" 6
    
    - name: Run release
      id: release
      shell: bash
      continue-on-error: true
      run: node "$GITHUB_WORKSPACE/.github/actions/release/release-build.js"
      env:
        PUBLISH_DIR: ${{ inputs.publish-dir }}
        NODEJS: ${{ inputs.nodejs }}
        ELECTRON: ${{ inputs.electron }}
        CREATE_ZIP: ${{ inputs.create-zip }}
        UPLOAD: ${{ inputs.upload }}
        REPORT_SERVER_URL: ${{ inputs.report-server-url }}
    
    - name: Check release result
      shell: bash
      if: steps.release.outputs.release_success != 'true'
      run: |
        echo "âš ï¸  éƒ¨åˆ†å‘å¸ƒç±»å‹æ„å»ºå¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
        # ä¸é€€å‡ºï¼Œè®©å·¥ä½œæµç»§ç»­æ‰§è¡Œä»¥ä¾¿æ˜¾ç¤ºè¯¦ç»†ç»“æœ

